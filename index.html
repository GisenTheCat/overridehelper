<html>
    <head>
        <title>Override Helper</title>
        <style>
            body {
                background-color: #121412;
                font-size: 50px;
            }
        </style>
        <script>
            let folderAccess;
            let overrides;
            const baseUrl = "https://gisenthecat.github.io/overridehelper/";
            const installedOverrides = {};
            async function getFolderAccess() {
                const handle = await window.showDirectoryPicker({
                    mode: "readwrite"
                });
                return handle;
            }
            async function listOverrides(folderHandle, curPath = "") {
                for await (const [name, handle] of folderHandle.entries()) {
                    console.log(curPath + handle.name);
                    if (handle.kind == "directory") {
                        await listOverrides(handle, curPath + handle.name + "/");
                    } else if (handle.kind == "file") {
                        installedOverrides[curPath + handle.name] = handle;
                    }
                }
            }
            async function readFile(fileHandle) {
                const file = await fileHandle.getFile();
                const text = await file.text();
                return text;
            }
            async function saveFile(fileHandle, content) {
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
            }
            async function createAndSaveFile(folderHandle, fileName, content) {
                const fileHandle = await folderHandle.getFileHandle(fileName, { create: true });
                await saveFile(fileHandle, content);
            }
            async function createFolder(parentFolderHandle, folderName) {
                const newFolderHandle = await parentFolderHandle.getDirectoryHandle(folderName, { create: true });
                return newFolderHandle;
            }
            async function deleteFile(folderHandle, fileName) {
                const fileHandle = await folderHandle.getFileHandle(fileName);
                await fileHandle.remove();
            }


            async function checkForUpdates() {
                for (let i = 0; i < Object.keys(installedOverrides).length; i++) {
                    let overrideName = Object.keys(installedOverrides)[i];
                    let overrideHandle = installedOverrides[overrideName];
                    if (overrides[overrideName] != undefined) {
                        await fetch(overrides[overrideName].src).then((res) => res.text()).then(async (text) => {
                            const oldText = await readFile(overrideHandle);
                            const newText = `(function(){var originalScript=document.createElement('script');originalScript.src='http${(overrides[overrideName].https ? "s://" : "://") + overrides[overrideName].path}?';document.head.appendChild(originalScript);})();var unsafeWindow=window;${text}`;
                            if (newText !== oldText) {
                                overrides[overrideName]["update"] = true;
                            } else {
                                overrides[overrideName]["update"] = false;
                            }
                        });
                    }
                }
            }
            async function install(extension) {
                let path = extension.split('/');
                let folder = folderAccess;
                let content = await fetch(overrides[extension].src).then((res) => res.text()).then((text) => `(function(){var originalScript=document.createElement('script');originalScript.src='http${(overrides[extension].https ? "s://" : "://") + overrides[extension].path}?';document.head.appendChild(originalScript);})();var unsafeWindow=window;${text}`);
                for (let i = 0; i < path.length - 1; i++) {
                    folder = await createFolder(folder, path[i]);
                }
                createAndSaveFile(folder, path[path.length - 1], content);
            }
            async function uninstall(extension) {
                let path = extension.split('/');
                let folder = folderAccess;
                let content = await fetch(overrides[extension].src).then((res) => res.text()).then((text) => `(function(){var originalScript=document.createElement('script');originalScript.src='http${(overrides[extension].https ? "s://" : "://") + overrides[extension].path}?';document.head.appendChild(originalScript);})();var unsafeWindow=window;${text}`);
                for (let i = 0; i < path.length - 1; i++) {
                    folder = await createFolder(folder, path[i]);
                }
                deleteFile(folder, path[path.length - 1]);
            }

            async function start() {
                document.body.removeAttribute("onclick");
                overrides = await fetch(baseUrl + "overrides.json").then((res) => res.json());
                folderAccess = await getFolderAccess();
                await listOverrides(folderAccess);
                await checkForUpdates();

                Object.values(overrides).forEach((override) => {
                        let overrideDiv = document.createElement("div");
                        overrideDiv.innerText = override.name;
                    if (installedOverrides[override.path]) {
                        overrideDiv.style.color = override.update ? "blue" : "green";
                        document.body.appendChild(overrideDiv);
                        if (override.update) {
                            let updateButton = document.createElement("button");
                            updateButton.innerText = "UPDATE";
                            updateButton.setAttribute("onclick", `install("${override.path}")`);
                            overrideDiv.appendChild(updateButton);
                        }
                        let uninstallButton = document.createElement("button");
                        uninstallButton.innerText = "UNINSTALL";
                        uninstallButton.setAttribute("onclick", `uninstall("${override.path}")`);
                        overrideDiv.appendChild(uninstallButton);
                    } else {
                        overrideDiv.style.color = "red";
                        document.body.appendChild(overrideDiv);
                        let installButton = document.createElement("button");
                        installButton.innerText = "INSTALL";
                        installButton.setAttribute("onclick", `install("${override.path}")`);
                        overrideDiv.appendChild(installButton);
                    }
                });
            }
        </script>
    </head>
    <body onclick="start()">

    </body>
</html>
