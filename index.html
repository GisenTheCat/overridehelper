<html>
    <head>
        <title>Override Helper</title>
        <style>
            body {
                background-color: #121412;
            }
        </style>
        <script>
            const baseUrl = "https://gisenthecat.github.io/overridehelper/";
            const installedOverrides = {};
            async function getFolderAccess() {
                const handle = await window.showDirectoryPicker({
                    mode: "readwrite"
                });
                return handle;
            }
            async function listOverrides(folderHandle, curPath = "") {
                for await (const [name, handle] of folderHandle.entries()) {
                    console.log(curPath + handle.name);
                    if (handle.kind == "directory") {
                        await listOverrides(handle, curPath + handle.name + "/");
                    } else if (handle.kind == "file") {
                        installedOverrides[curPath + handle.name] = handle;
                    }
                }
            }
            async function readFile(fileHandle) {
                const file = await fileHandle.getFile();
                const text = await file.text();
                return text;
            }
            async function saveFile(fileHandle, content) {
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
            }
            async function createAndSaveFile(folderHandle, fileName, content) {
                const fileHandle = await folderHandle.getFileHandle(fileName, { create: true });
                await saveFile(fileHandle, content);
            }
            async function createFolder(parentFolderHandle, folderName) {
                const newFolderHandle = await parentFolderHandle.getDirectoryHandle(folderName, { create: true });
                return newFolderHandle;
            }

            async function checkForUpdates(overrides) {
                for (let i = 0; i < Object.keys(installedOverrides).length; i++) {
                    let overrideName = Object.keys(installedOverrides)[i];
                    let overrideHandle = installedOverrides[overrideName];
                    if (overrides[overrideName] != undefined) {
                        fetch(overrides[overrideName].src).then((res) => res.text()).then(async (text) => {
                            const oldText = await readFile(overrideHandle);
                            const newText = `(function(){var originalScript=document.createElement('script');originalScript.src='${overrides[overrideName].src}?';document.head.appendChild(originalScript);})();var unsafeWindow=window;${text}`;
                            if (newText !== oldText) {
                                overrides[overrideName]["update"] = true;
                            } else {
                                overrides[overrideName]["update"] = false;
                            }
                        })
                    }
                }
            }

            async function start() {
                document.body.onclick = "";
                const overrides = await fetch(baseUrl + "overrides.json").then((res) => res.json());
                let folderAccess = await getFolderAccess();
                await listOverrides(folderAccess);
                await checkForUpdates(overrides);

                console.log(overrides);

                Object.values(overrides).forEach((override) => {
                    if (installedOverrides[override.path]) {
                        console.log(override.name + (override.update ? " has an update" : " is awesome"))
                    } else {
                        console.log(override.name + " is not installed")
                    }
                });
            }
        </script>
    </head>
    <body onclick="start()">

    </body>
</html>
